- hosts: appservers
  remote_user: miles2
  serial: "50%"
  vars:
      appfolderMap: {"im-ui":"InvoiceManagerUI","im-pdfgenerator":"PDFGenerator","im-preprocessor":"Preprocessor"}

  tasks:
    -
      name: Set the application folder
        set_fact:
          appfolder: "{{appfolderMap[app]}}"
    -
      name: "{{app}}@{{inventory_hostname}} - Making sure base directory {{app_basedir}} exists"
      become: true
      file:
        path={{app_basedir}}
        state=directory
        owner=miles2

    -
      name: "{{app}}@{{inventory_hostname}} - Making sure directory {{app_basedir}}/{{app}} exists"
      become: true
      file:
        path={{app_basedir}}/{{app}}
        state=directory
        owner=miles2

    -
      name: "{{app}}@{{inventory_hostname}} - Making sure directory {{app_basedir}}/{{app}}/current exists"
      become: true
      file:
        path={{app_basedir}}/{{app}}/current
        state=directory
        owner=miles2
    -
      name: "{{app}}@{{inventory_hostname}} - Making sure directory {{app_basedir}}/{{app}}/previous exists"
      become: true
      file:
        path={{app_basedir}}/{{app}}/previous
        state=directory
        owner=miles2
    -
      name: "{{app}}@{{inventory_hostname}} - Making sure directory /var/log/invoicemanager/{{app}}/ exists"
      become: true
      file:
        path=/var/log/invoicemanager/{{app}}/
        state=directory
        owner=miles2

    -
      name: "{{app}}@{{inventory_hostname}} - Copying new binaries"
      copy:
        src="{{item}}"
        dest={{app_basedir}}/{{app}}/current/
        mode=0700
      with_fileglob :
        - ../{{appfolder}}/target/*.jar

    -
      name: "{{app}}@{{inventory_hostname}} - Copying config"
      template:
        src=templates/{{app}}/{{item}}
        dest={{app_basedir}}/{{app}}/current/{{item}}
        owner=miles2
      with_items:
        - application.yml
